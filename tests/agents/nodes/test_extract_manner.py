import time

from langchain_core.messages import HumanMessage

from agents.nodes.extract_conversation_style import MannerExtractNode
from models import MistralLargeModel as model
from models.config import MistralLargeAPIConfig as model_config
from langchain_ollama import ChatOllama

local_llm = "gemma3:4b"
llm = ChatOllama(model=local_llm)

critique_model = llm
critique_prompt = """
Ты - эксперт по стилю общения. Ты умеешь извлекать и анализировать различные данные о манере общения человека по сообщениям.
Твоя задача - оценить насколько точно, в пределах от 0% до 100%(с пояснениями), из сообщений пользователя неизвестно кому удалось извлечь данные о манере(тон, эмоциональность, обращение к пользователю, дополнительная информация)

Сообщения пользователя:
{messages}

извлеченные данные:
- тон - {tone}
- эмоциональность - {emotionality}
- обращение к пользователю - {appeal}
- дополнительная информация - {additionally}
"""

# 90-95% - gemma3:4b
# 80-85% - deepseek

# Deepseek сильно критикует тон из-за "дружелюбный"

{  # **Оценка точности извлеченных данных: 95%**
    # **Обоснование:**
    # Я считаю, что данные, извлеченные из данного сообщения, достаточно точно отражают манеру общения пользователя.  Вот почему:
    # *   **Тон – полуформальный, дружелюбный, уверенный, серьёзный (95%):**  Сообщение начинается с обозначения задачи ("У меня есть задание..."), что указывает на уверенный тон.  Использование фразы "Придумай...", "Нужно придумать...", "Не забывай..." подразумевает дружелюбное, но серьёзное обращение к собеседнику, как к помощнику, который должен предложить идеи и решения.
    # *   **Эмоциональность – умеренная (90%):**  Сообщение не содержит выраженных эмоций (гнев, радость, разочарование).  Вместо этого, преобладает рациональный подход и желание четко определить шаги для достижения цели.
    # *   **Обращение к пользователю – нейтрально-вежливое (100%):**  Использование "У меня есть задание", "Придумай...", "Нужно придумать..." является вежливым, но не личным обращением. Нет обращения "Вы" или других форм, указывающих на большую степень близости.
    # *   **Дополнительная информация – Длинные предложения, Специфичные фразы и структурированное изложение (100%):**  Сообщение состоит из длинных, хорошо структурированных предложений, которые показывают, что пользователь мыслит логически и стремится к детальному описанию проекта.  Использование специфических терминов ("террарий", "процедурная генерация", "godot") подтверждает его профессиональный интерес и знание предметной области.
    # **Краткое пояснение:**
    # Данное сообщение демонстрирует специфику общения человека, занимающегося разработкой игр.  Он/она логичен, структурирован, старается точно описать свои
    # потребности, использует специфическую терминологию и обращается к собеседнику, как к партнеру в решении сложной задачи.
    # Я оцениваю точность извлеченных данных на 95% потому, что, хотя описание в целом соответствует реальности, в данных про эмоционность и тон убрана часть
    # нюансов, которые могли бы быть отражены в более детальном анализе.
}

# messages = [
#     "У меня есть задание реализовать игру с сюжетом. Я планирую сделать игру похожую на террарию на движке godot. Начнем с сюжета. Персонаж спавнится в мире, нужно придумать почему так происходит. Придумай 10 боссов, их поведение и сюжетный лор. Не забывай про баланс чтобы от простого босса к сложному"
#     "Теперь следующее. Нужно придумать карту (процедурная генерация и фиксированая еще не знаю) она будет как в террарии т.е 2d.  Затем, какие будут оружия и классы(не выбор класса а просто оружия и аксесуары, которые будут формировать 'класс') Так же нужен более глубокий лор для каждого босса и его мотивация сражаться с игроком. После этого надо сделать наброски игры в godot"
#     "а какой движок лучше использовать godot или есть лучше?"
# ]
# {'tone': 'полуформальный, дружелюбный, уверенный, серьёзный', 'emotionality': 'умеренная', 'appeal': 'нейтрально-вежливое', 'additionally': ['Длинные предложения', 'Специфичные фразы и структурированное изложение']}


# 90% - gemma3:4b
# 30-45% - deepseek
# messages = [
#   "я могу на 2xl как-то отрубить такие стили у div: sm:row-start-2 sm:row-end-3 sm:col-start-1 sm:col-end-2",
#   "прости, что перебил, начни заново писать",
#   "вот так сейчас ведет себя верстка при 1280+ с твоим кодом, так недолжно быть,",
# ]
# {'tone': 'полуформальный, дружелюбный, уверенный, серьёзный', 'emotionality': 'умеренная', 'appeal': 'нейтрально-вежливое', 'additionally': ['использование специфичных терминов', 'длинные предложения', 'отсутствие сокращений', 'отсутствие сленга']}

{
    #   Оценка точности извлеченных данных: **90%**
    # **Обоснование:**
    # Данная оценка высока, поскольку большинство извлеченных данных полностью подтверждается анализом сообщений пользователя. Рассмотрим каждый аспект:
    # *   **Тон - полуформальный, дружелюбный, уверенный, серьёзный:**  Сообщение "прости, что перебил, начни заново писать" указывает на дружелюбное и неформальное извинение, а также на уверенность в том, что ошибка произошла и требуется исправление. "Вот так сейчас ведет себя верстка..." добавляет элемент серьёзности и критического анализа.
    # *   **Эмоциональность - умеренная:**  Извинение и указание на проблему не выражают сильных негативных эмоций, а лишь аккуратную озабоченность.
    # *   **Обращение к пользователю - нееформальное обращение ("ты")** -  Использование "ты" в сочетании с извинениями и прямым указанием на ошибку указывает на неформальное общение.
    # *   **Дополнительная информация - использование разговорного стиля, короткие предложения, технические термины:**  Сообщение о стилях CSS ("2xl", "sm:row-start-2...", "col-start-1...") однозначно содержит техническую информацию и, соответственно, использует профессиональную терминологию.  Использование коротких предложений и непосредственное обращение ("начни заново писать") указывает на более разговорный, неформальный стиль, хотя техническая информация требует более формального подхода.
    # **Небольшое снижение оценки (до 90%)** связано с тем, что "полуформальный" тон может быть немного субъективным. Сообщение, содержащее технические термины и конкретные инструкции, склоняется к более формальному стилю, чем просто дружелюбное.  Однако, учитывая общий контекст и нюансы в сообщениях,  оценка в 90% вполне оправдана.
    # В целом, анализ очень точный и отражает ключевые особенности манеры общения пользователя.
}

# 85% - gemma3:4b
# 55-65% - deepseek
messages = [
    " напиши промпт для бота который будет общаться с клиентом от имени менеджера Яны. "
    "Основная информация: ....",
    " какого хуя у bnovo их апи нихуя не работает",
    " # Метод расщепления. Точное решение $$ u = t + x^2 + y^2 $$ "
    "используя заданное точное решение, необходимо построить начально-краевую задачу для уравнения "
    "теплопроводности и затем решить указанным ниже методом. пространственные переменные "
    "меняются на отрезке [0, 1] шаги по пространству берутся равным 0,1.",
]
# {'tone': 'Неформальный, агрессивный, уверенный, серьёзный', 'emotionality': 'Высокая', 'appeal': "Неформальное обращение ('ты', 'привет')", 'additionally': ['Использование сленга / Жаргона', 'Длинные предложения', 'Технический язык']}
# {'tone': 'Полуформальный, нейтральный, уверенный, серьёзный', 'emotionality': 'Низкая', 'appeal': 'Нейтрально-вежливое', 'additionally': ['Использование технического языка', 'Длинные предложения', 'Структурированные сообщения']}
{
    #   Оценка точности извлеченных данных: **85%**
    # **Пояснения:**
    # Я считаю, что оценка в 85% является обоснованной, поскольку все указанные признаки действительно присутствуют в сообщениях пользователя.  Рассмотрим каждый пункт:
    # *   **Тон - Неформальный, агрессивный, уверенный, серьёзный:**  Сообщение "какого хуя у bnovo их апи нихуя не работает"  чётко указывает на агрессию и раздражение.  При этом, просьба "напиши промпт..." и последующее описание задачи подразумевают уверенность в своей правоте и серьёзность подхода.
    # *   **Эмоциональность - Высокая:**  В целом, сообщения содержат явные признаки сильных эмоций, выраженные как в нецензурной бракане ("какого хуя"), так
    # и в выражении недовольства ("нихуя не работает").
    # *   **Обращение к пользователю - Неформальное обращение ('ты', 'привет'):**  Использование "ты" в запросе "напиши промпт..." прямо указывает на неформальное обращение.
    # *   **Дополнительная информация - Использование сленга / Жаргона, Длинные предложения, Технический язык:**  Сленг ("хуя") и жаргон ("нихуя")  безусловно присутствуют. Длинные, сложные предложения (в частности, в техническом описании) характерны для пользователя.
    # **Почему не 100%?**
    # Я не уверен на 100% в  оценке "уверенности" как отдельного признака, так как она не выражена прямо, а скорее подразумевается контекстом.  Также,  может
    # быть,  в сообщениях есть моменты, которые  не так явно  отражают  "серьезность".  Более детальный анализ, например,  рассмотрение слов и фраз на предмет  попыток  оправдания или  описания ситуации, мог бы повысить точность.
    # В целом, извлеченные данные правдиво отражают поведение пользователя,  и я считаю, что 85% - это достаточно высокая оценка.
}

# Gemma 3(4b параметров) выдает ~90% правильности в среднем
# Deepseek показывает ~60% в среднем.
# Ему не нравится определение тона и эмоциональности, из-за этого снижает и очень сильн о критикует.
# Их стоит расширить и получше контролировать

test_state = {
    "messages": [HumanMessage(content=i) for i in messages],
    "is_info_in_memory": False,
    "remaining_steps_to_check_manner": 0,
}

node = MannerExtractNode()
node_result = node.execute(state=test_state)
manner = node_result.update.get("manner")
print(f"\n{manner}\n")
data_to_critique = {
    "messages": messages,
    "tone": manner["tone"],
    "emotionality": manner["emotionality"],
    "appeal": manner["appeal"],
    "additionally": ", ".join(manner["additionally"]),
}
final_prompt = critique_prompt.format(**data_to_critique)

time.sleep(2)
result = critique_model.invoke(final_prompt)

print(f"\nРЕЗУЛЬТАТ КРИТИКА\n{result.content}")
